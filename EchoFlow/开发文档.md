# EchoFlow Native 开发架构文档 (v4.1 - UI Integrated)

**版本**: 4.1 (基于 HTML 原型整合)
**状态**: UI/UX 规范确立
**技术栈**: Swift 5.9+, SwiftUI, SwiftData, CloudKit

---

## 1. 架构总览 (Overview)

EchoFlow Native 版旨在打造 macOS 平台下性能最强、体验最原生的剪贴板管理工具。UI 设计严格遵循已确认的 HTML 原型（四向停靠、玻璃拟态、双视图切换）。

### 1.1 核心特性
* **零延迟**: 毫秒级启动，列表滚动维持 120Hz 高刷。
* **极小体积**: 安装包预计 < 10MB。
* **原生拟态**: 使用 SwiftUI Material API 还原 HTML 中的 `.glass-panel` 效果。
* **动态布局**: 完美复现 HTML 原型中的“水平/垂直”自动切换逻辑。

---

## 2. 窗口管理与停靠逻辑 (Window & Docking)

对应 HTML 原型中的 `setPanelPosition` 逻辑，SwiftUI 需实现动态的 `Frame` 和布局策略。

### 2.1 悬浮面板 (NSPanel)
* **类型**: `NSPanel` (Non-activating, Floating)。
* **背景**: 完全透明 (`backgroundColor = .clear`)，由 SwiftUI 的 `RootView` 提供模糊背景。

### 2.2 四向停靠策略 (Docking Strategy)
需在 `WindowManager` 中监听屏幕尺寸变化，并根据用户设置调整 Panel 的 Frame。

| 停靠位置 | 布局模式 | 尺寸定义 | 滚动方向 | 对应 HTML 类 |
| :--- | :--- | :--- | :--- | :--- |
| **Bottom** | Horizontal | 宽 100% Screen, 高自适应 | `.horizontal` | `.layout-horizontal` |
| **Top** | Horizontal | 宽 100% Screen, 高自适应 | `.horizontal` | `.layout-horizontal` |
| **Left** | Vertical | 宽 18rem (约 288pt), 高 100% Screen | `.vertical` | `.layout-vertical` |
| **Right** | Vertical | 宽 18rem (约 288pt), 高 100% Screen | `.vertical` | `.layout-vertical` |

> **开发注意**: 在 SwiftUI 中，需通过 `@EnvironmentObject` 注入 `layoutMode` 状态，动态切换 `ScrollView` 的轴向 (`Axis.Set`) 和 `HStack`/`VStack`。

---

## 3. 核心功能模块设计

### 3.1 剪贴板数据模型 (Model)
基于 HTML 原型中卡片展示的信息，扩充 SwiftData 模型：

```swift
@Model
final class ClipboardItem {
    var id: UUID
    var type: ContentType // Code, Link, Image, File, Text
    var content: String
    var imageData: Data? 
    
    // UI 强相关字段
    var sourceApp: String // e.g., "VS Code"
    var themeColorHex: String // 对应 HTML 卡片头部的颜色 (e.g., #007ACC)
    var timestamp: Date
    
    // 快捷键索引 (用于显示卡片右下角的 ⌘1)
    var shortcutIndex: Int? 
}
```

### 3.2 笔记模型 (Note Model)
对应 HTML 中的 `view-notes` 视图：

```swift
@Model
final class NoteItem {
    var id: UUID
    var content: String // 支持简单富文本
    var createdAt: Date
    // 对应 HTML 中不同颜色的笔记卡片 (Yellow, Gray...)
    var colorTheme: String 
}
```

---

## 4. UI 架构 (SwiftUI Implementation)

### 4.1 视图层级映射
将 HTML 结构映射为 SwiftUI 组件结构：

```swift
RootView
 ├── GlassBackground (.ultraThinMaterial)
 └── MainLayout (HStack or VStack based on Docking)
      ├── ContentArea (Flexible)
      │    ├── TopBar
      │    │    ├── SearchField (with expansion logic)
      │    │    ├── SegmentControl (Clipboard / Notes)
      │    │    └── ActionButtons (Paste, Theme, Settings)
      │    └── ScrollView (LazyStack)
      │         ├── ClipboardCards...
      │         └── NoteCards...
      └── Sidebar (Fixed width)
           ├── FilterTabs (All, Text, Image, Link)
           └── AddButton
```

### 4.2 卡片样式还原 (Card Styling)
HTML 中的 `.card-bg` 和头部颜色条需要在 SwiftUI 中精准还原。

* **通用容器**:
    ```swift
    VStack(spacing: 0) {
        HeaderBar(color: item.themeColor) // 顶部彩色条
        ContentPreview(item: item)        // 内容区域
    }
    .background(.ultraThinMaterial)       // 玻璃背景
    .cornerRadius(12)
    .shadow(radius: 4)
    ```

* **特殊类型适配**:
    * **Code**: 使用 `Monospaced` 字体，模拟简单的语法高亮颜色。
    * **Link**: 使用 `LinkPresentation` 框架获取 OpenGraph 预览图，或本地缓存。
    * **Image**: 使用 `AsyncImage` 加载缩略图。

### 4.3 搜索交互 (Search Interaction)
对应 HTML 中的交互逻辑：
* **Vertical 模式**: 搜索框折叠为图标按钮，点击弹出 `GlobalSearchModal`。
* **Horizontal 模式**: 搜索框展开在顶部工具栏。
* **GlobalSearchModal**: 一个独立的 `NSPanel` 或全屏覆盖层 (`ZStack`)，带模糊背景，支持键盘导航。

### 4.4 设置面板 (Settings Modal)
复刻 HTML 中的 Sidebar Tab 布局：
* 使用 `NavigationSplitView` 或自定义 `HStack` 布局。
* **Tabs**: 通用 (General), 规则 (Rules), 快捷键 (Shortcuts), 订阅 (Subscription)。
* **样式**: 纯白/深色半透明背景，左侧导航栏高亮状态需与 HTML 一致。

---

## 5. 目录结构规范

```text
/EchoFlow
  /App
    ├── EchoFlowApp.swift
    └── AppDelegate.swift
  /Core
    ├── Managers (PasteboardManager, WindowManager)
    └── Models (ClipboardItem, NoteItem)
  /UI
    ├── Components
    │   ├── CardView.swift          # 单个卡片组件
    │   ├── HeaderBar.swift         # 卡片顶部色条
    │   └── SegmentControl.swift    # 视图切换控件
    ├── Layouts
    │   ├── HorizontalDockView.swift # 底部/顶部布局
    │   └── VerticalDockView.swift   # 左侧/右侧布局
    └── Modals
        ├── SettingsView.swift      # 设置面板
        └── GlobalSearchView.swift  # 全局搜索
  /Resources
    ├── Assets.xcassets
    └── Colors.swift (定义 VSCodeBlue, ChromeRed 等颜色)
```

## 6. 开发路线图 (Roadmap)

### Phase 1: 核心框架与布局 (UI First)
* [ ] 实现 `WindowManager`，支持 `NSPanel` 的四向停靠计算。
* [ ] 搭建 SwiftUI `RootView`，实现 Horizontal/Vertical 布局的动态切换。
* [ ] 复刻 HTML 中的 "Glassmorphism" 视觉效果。

### Phase 2: 数据接入与组件 (Data Binding)
* [ ] 实现 SwiftData 模型，并接入剪贴板监听。
* [ ] 开发 `CardView`，根据数据类型 (Code/Link/Image) 动态改变头部颜色和内容布局。
* [ ] 实现 `SegmentControl` 切换剪贴板/笔记视图。

### Phase 3: 交互完善 (Interactions)
* [ ] 实现笔记的创建 (`createNewNote`) 与编辑功能。
* [ ] 开发全局搜索弹窗 (`GlobalSearchView`)。
* [ ] 完成设置面板的 Tab 切换与配置持久化 (`AppStorage`)。