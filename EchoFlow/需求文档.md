# EchoFlow Native (macOS) 产品需求文档 (PRD)

**版本**: 1.0
**日期**: 2025-11-29
**目标受众**: Cursor AI (作为 Senior macOS Engineer)

## 1. 项目概述 (Project Overview)

**EchoFlow** 是一款专为 macOS 设计的高性能、原生体验的剪贴板管理与轻量笔记工具。

* **核心价值**: 零延迟启动、极致的视觉体验（原生玻璃拟态）、无缝的多端同步。

* **形态**: 菜单栏应用 (MenuBar App)，无 Dock 图标，通过快捷键唤出悬浮面板。

## 2. 技术栈约束 (Tech Stack Constraints)

* **语言**: Swift 5.9+

* **UI 框架**: SwiftUI (macOS Target)

* **数据存储**: SwiftData (基于 Core Data 的现代封装)

* **云同步**: CloudKit (NSPersistentCloudKitContainer)

* **窗口系统**: AppKit (`NSPanel` 子类) + SwiftUI 宿主

* **系统交互**: Accessibility API (模拟按键), Carbon (全局热键), AppKit (剪贴板监听)

## 3. 功能需求 (Functional Requirements)

### 3.1 窗口与布局管理 (Window & Docking)

* **悬浮面板**: 应用主窗口必须是一个悬浮的 `NSPanel`，背景全透明，不可抢占主窗口焦点。

* **四向停靠 (4-Way Docking)**:

  * 支持用户设置面板停靠在屏幕的：底部 (Bottom)、顶部 (Top)、左侧 (Left)、右侧 (Right)。

  * **布局自适应**:

    * **水平模式 (Horizontal)**: 当停靠在底部或顶部时，内容列表横向滚动 (`HStack`)。

    * **垂直模式 (Vertical)**: 当停靠在左侧或右侧时，内容列表纵向滚动 (`VStack`)，且宽度固定 (约 280pt)。

* **自动隐藏**: 失去焦点时自动隐藏面板。

### 3.2 剪贴板历史 (Clipboard History)

* **监听**: 后台自动监听系统剪贴板变化 (轮询或监听器)。

* **过滤**:

  * 忽略密码管理器 (如 1Password, Keychain)。

  * 忽略特定类型的元数据 (Transient data)。

  * 去重 (Hash 校验)。

* **内容类型识别**:

  * **Text**: 纯文本。

  * **Image**: 图片数据 (需生成缩略图)。

  * **Link**: URL 链接。

  * **Color**: 十六进制颜色代码。

  * **File**: 文件路径。

* **自动粘贴**: 点击历史记录项，应用隐藏，并模拟 `Cmd+V` 将内容粘贴到当前激活的窗口。

### 3.3 笔记功能 (Quick Notes)

* **独立视图**: 通过分段控制器 (Segment Control) 在“剪贴板”和“笔记”之间切换。

* **创建**: 提供快速入口创建纯文本笔记。

* **编辑**: 笔记内容支持直接编辑。

### 3.4 搜索与过滤 (Search & Filter)

* **布局响应式搜索**:

  * **水平模式**: 搜索框完整显示在顶部工具栏。

  * **垂直模式**: 搜索框折叠为“放大镜”图标，点击后弹出独立的全局搜索模态框。

* **功能**: 支持模糊搜索内容文本、来源应用名称。

## 4. UI/UX 设计规范 (Design Specs)

### 4.1 视觉风格 (Glassmorphism)

* **背景**: 必须使用 SwiftUI 的 `.background(.ultraThinMaterial)` 实现原生毛玻璃效果。

* **圆角**: 统一使用 `cornerRadius: 12` 或 `16`。

* **深色模式**: UI 必须自动适配 macOS 的 Light/Dark 模式。

### 4.2 卡片样式 (Card View)

参考 HTML 原型设计，所有卡片尺寸统一 (例如 `160x160` pt)。

* **头部 (Header)**:

  * 高度约 30pt。

  * 背景色：根据来源 App 提取的主色调 (Theme Color)。

  * 左侧：来源 App 图标。

  * 右侧：内容类型标识 (CODE, LINK, IMG) + 相对时间 (2m ago)。

* **内容区 (Body)**:

  * **代码/文本**: 显示前几行，等宽字体，淡色背景。

  * **图片**: 显示缩略图，填充模式 (`.scaledToFill`)。

  * **链接**: 显示 OpenGraph 图片或占位符 + 域名。

* **快捷键提示**: 卡片右下角悬浮显示快捷键索引 (如 `⌘1`, `⌘2`)。

### 4.3 设置面板 (Settings)

* 独立模态窗口。

* 侧边栏导航：通用 (General)、规则 (Rules)、快捷键 (Shortcuts)、订阅 (Subscription)。

## 5. 数据模型定义 (Data Schema)

使用 SwiftData 定义模型：

```swift
import SwiftData
import Foundation

@Model
final class ClipboardItem {
    @Attribute(.unique) var id: UUID
    var content: String         // 文本内容或文件路径
    var imageData: Data?        // 图片二进制
    var typeRaw: String         // Enum: text, image, file, link, code
    var sourceApp: String       // e.g., "Xcode"
    var themeColorHex: String   // e.g., "#007ACC"
    var createdAt: Date
    var isFavorite: Bool
    
    init(...) { ... }
}

@Model
final class NoteItem {
    @Attribute(.unique) var id: UUID
    var content: String
    var createdAt: Date
    var colorTheme: String      // 笔记卡片颜色
    
    init(...) { ... }
}
```

## 6. 项目结构 (Project Structure)

```text
/EchoFlow
  /App
    EchoFlowApp.swift       # 入口 (MenuBarExtra + WindowGroup)
    AppDelegate.swift       # 生命周期与原生事件处理
  /Core
    /Managers
      PasteboardManager.swift  # 监听逻辑
      WindowManager.swift      # 停靠与尺寸计算
      HotKeyManager.swift      # 全局快捷键
    /Models
      ItemModels.swift         # SwiftData Models
  /UI
    /Components             # 原子组件 (GlassCard, HeaderBar)
    /Views
      /Main
        RootView.swift      # 主容器
        ClipboardListView.swift
        NotesListView.swift
      /Settings
        SettingsView.swift
  /Resources                # Assets, Colors
```

## 7. 执行计划 (Implementation Roadmap)

请 Cursor 按照以下步骤辅助开发：

1. **基础框架搭建**:

   * 创建纯 Swift macOS 工程。

   * 配置 `Info.plist` (LSUIElement)。

   * 实现 `NSPanel` 的封装和基本的四向停靠逻辑 (`WindowManager`)。

2. **数据层与监听**:

   * 建立 SwiftData 模型。

   * 编写 `PasteboardManager`，实现定时轮询和数据去重写入。

3. **UI 核心实现**:

   * 实现 `.layout-horizontal` 和 `.layout-vertical` 的 SwiftUI 响应式布局。

   * 还原 HTML 原型中的卡片样式 (`CardView`)。

   * 集成玻璃拟态背景。

4. **交互完善**:

   * 实现双视图切换 (Clipboard/Notes)。

   * 实现搜索交互 (展开/折叠逻辑)。

   * 实现 `Auto Paste` 模拟按键功能。

5. **收尾**:

   * CloudKit 同步配置。

   * 性能优化 (LazyVStack)。