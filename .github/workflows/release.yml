name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的 tag 时触发，如 v1.0.0

# 授权 GITHUB_TOKEN 创建 Release 和上传文件
permissions:
  contents: write

env:
  SCHEME: EchoFlow
  PRODUCT_NAME: EchoFlow

jobs:
  build:
    runs-on: macos-14  # 使用 macOS 14 (Sonoma) runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Update version in project
      run: |
        # 更新 Info.plist 中的版本号
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.get_version.outputs.VERSION }}" "${{ env.SCHEME }}/Info.plist" 2>/dev/null || true
        # 使用 agvtool 更新版本
        cd "${{ env.SCHEME }}.xcodeproj/.."
        agvtool new-marketing-version ${{ steps.get_version.outputs.VERSION }} || true
        
    - name: Clean build directory
      run: |
        rm -rf "$PWD/build"
        mkdir -p "$PWD/build"
        
    - name: Build Archive
      run: |
        # 使用与本地 build-package.sh 相同的构建参数
        xcodebuild archive \
          -project "${{ env.SCHEME }}.xcodeproj" \
          -scheme "${{ env.SCHEME }}" \
          -configuration Release \
          -archivePath "$PWD/build/${{ env.PRODUCT_NAME }}.xcarchive" \
          -destination "generic/platform=macOS" \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=YES \
          CODE_SIGN_STYLE="Manual" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          ENABLE_PREVIEWS=NO \
          DEVELOPMENT_TEAM="" \
          || {
            echo "❌ xcodebuild 构建失败"
            exit 1
          }
        echo "✅ Archive 构建成功"
          
    - name: Export App
      run: |
        # 直接从 archive 中复制 app（与本地脚本一致）
        mkdir -p "$PWD/build/Export"
        cp -R "$PWD/build/${{ env.PRODUCT_NAME }}.xcarchive/Products/Applications/${{ env.PRODUCT_NAME }}.app" "$PWD/build/Export/"
        
        if [ ! -d "$PWD/build/Export/${{ env.PRODUCT_NAME }}.app" ]; then
          echo "❌ App 导出失败"
          exit 1
        fi
        echo "✅ App 已导出"
        
    - name: Fix signature and quarantine
      run: |
        APP_PATH="$PWD/build/Export/${{ env.PRODUCT_NAME }}.app"
        
        # 1. 移除隔离属性（防止系统报"文件已损坏"）
        xattr -cr "$APP_PATH"
        
        # 2. 强制深度重签名（Ad-hoc）
        # --preserve-metadata=identifier,entitlements,flags: 保留原有的权限声明
        codesign --force --deep --preserve-metadata=identifier,entitlements,flags --sign - "$APP_PATH" || {
          echo "❌ 签名修复失败"
          exit 1
        }
        
        # 验证签名
        echo "✅ 签名已修复"
        codesign -dv "$APP_PATH" 2>&1 | grep "Signature=" || true
        
    - name: Create DMG
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        DMG_DIR="$PWD/build/dmg-contents"
        DMG_PATH="$PWD/build/${{ env.PRODUCT_NAME }}-${VERSION}.dmg"
        
        # 创建临时目录用于 DMG
        rm -rf "$DMG_DIR"
        mkdir -p "$DMG_DIR"
        
        # 复制 App
        cp -R "$PWD/build/Export/${{ env.PRODUCT_NAME }}.app" "$DMG_DIR/"
        
        # 创建指向 Applications 的符号链接
        ln -s /Applications "$DMG_DIR/Applications"
        
        # 创建 DMG
        hdiutil create -volname "${{ env.PRODUCT_NAME }}" \
          -srcfolder "$DMG_DIR" \
          -ov -format UDZO \
          "$DMG_PATH" -quiet
        
        echo "✅ DMG 已生成: $DMG_PATH"
          
    - name: Create ZIP
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        ZIP_PATH="$PWD/build/${{ env.PRODUCT_NAME }}-${VERSION}.zip"
        
        cd "$PWD/build/Export"
        zip -r -y "$ZIP_PATH" "${{ env.PRODUCT_NAME }}.app"
        
        echo "✅ ZIP 已生成: $ZIP_PATH"
        
    - name: Generate Release Notes
      id: release_notes
      run: |
        # 尝试从 CHANGELOG.md 提取当前版本的更新说明
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        if [ -f "CHANGELOG.md" ]; then
          # 提取当前版本的更新内容
          NOTES=$(awk "/^## \[?v?$VERSION\]?|^## v?$VERSION/{flag=1; next} /^## /{flag=0} flag" CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            NOTES="Release version $VERSION"
          fi
        else
          NOTES="Release version $VERSION"
        fi
        
        # 写入到文件
        echo "$NOTES" > release_notes.md
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "EchoFlow v${{ steps.get_version.outputs.VERSION }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          build/${{ env.PRODUCT_NAME }}-${{ steps.get_version.outputs.VERSION }}.dmg
          build/${{ env.PRODUCT_NAME }}-${{ steps.get_version.outputs.VERSION }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EchoFlow-${{ steps.get_version.outputs.VERSION }}
        path: |
          build/*.dmg
          build/*.zip
        retention-days: 30

